#include <string.h>
#include <inttypes.h>
#include <stdio.h>
#include <stdbool.h>

#include <stdint.h>

#include "sys/node-id.h"
#include "net/netstack.h"
#include "deployment.h"

#if LINKADDR_SIZE > IEEE_ADDR_LEN
#error Wrong address sizes
#endif

unsigned short int node_id = 0;

static const struct id_addr deployment_id_addr_list[] = {
{ 1, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF7, 0x9C}}, //DEPT
{ 2, {0x00, 0x12, 0x4B, 0x00, 0x14, 0xB5, 0xD9, 0x76}}, //DEPT
{ 3, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF3, 0x84}}, //DEPT
{ 4, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF3, 0xEE}}, //DEPT
{ 5, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF7, 0x92}}, //DEPT
{ 6, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF3, 0x9A}}, //DEPT
{ 7, {0x00, 0x12, 0x4B, 0x00, 0x14, 0xB5, 0xDE, 0x21}}, //DEPT
{ 8, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF2, 0xA1}}, //DEPT
{ 9, {0x00, 0x12, 0x4B, 0x00, 0x14, 0xB5, 0xD8, 0xB5}}, //DEPT
{10, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF2, 0x1E}}, //DEPT
{11, {0x00, 0x12, 0x4B, 0x00, 0x14, 0xB5, 0xD9, 0x5F}}, //DEPT
{12, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF2, 0x33}}, //DEPT
{13, {0x00, 0x12, 0x4B, 0x00, 0x14, 0xB5, 0xDE, 0x0C}}, //DEPT
{14, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF2, 0x0E}}, //DEPT
{15, {0x00, 0x12, 0x4B, 0x00, 0x14, 0xB5, 0xD9, 0x49}}, //DEPT
{16, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF3, 0xDC}}, //DEPT
{17, {0x00, 0x12, 0x4B, 0x00, 0x14, 0xB5, 0xD9, 0x23}}, //DEPT
{18, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF3, 0x8B}}, //DEPT
{19, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF3, 0xC2}}, //DEPT
{20, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF3, 0xB7}}, //DEPT
{21, {0x00, 0x12, 0x4B, 0x00, 0x14, 0xB5, 0xDE, 0xE4}}, //DEPT
{22, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF3, 0x88}}, //DEPT
{23, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF7, 0x9A}}, //DEPT
{24, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF7, 0xE7}}, //DEPT
{25, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF2, 0x85}}, //DEPT
{26, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF2, 0x27}}, //DEPT
{27, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF2, 0x64}}, //DEPT
{28, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF3, 0xD3}}, //DEPT
{29, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF3, 0x8D}}, //DEPT
{30, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF7, 0xE1}}, //DEPT
{31, {0x00, 0x12, 0x4B, 0x00, 0x14, 0xB5, 0xDE, 0xAF}}, //DEPT
{32, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF2, 0x91}}, //DEPT
{33, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF2, 0xD7}}, //DEPT
{34, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF3, 0xA3}}, //DEPT
{35, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF2, 0xD9}}, //DEPT
{36, {0x00, 0x12, 0x4B, 0x00, 0x14, 0xB5, 0xD9, 0x9F}}, //DEPT
{100, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x15, 0xDB}}, //DEPT
{101, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x15, 0x3D}}, //DEPT
{102, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x16, 0x5B}}, //DEPT
{103, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x14, 0xC3}}, //DEPT
{104, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x15, 0x8C}}, //DEPT
{105, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x15, 0xF3}}, //DEPT
{106, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x16, 0x1B}}, //DEPT
{107, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x14, 0x97}}, //DEPT
{108, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x15, 0xB4}}, //DEPT
{109, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x14, 0xDE}}, //DEPT
{110, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x16, 0x36}}, //DEPT
{111, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x14, 0xF2}}, //DEPT
{113, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x15, 0x5A}}, //DEPT
{114, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x16, 0x16}}, //DEPT
{115, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x15, 0xD4}}, //DEPT
{116, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x15, 0xDA}}, //DEPT
{117, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x14, 0xDA}}, //DEPT
{118, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x14, 0xEA}}, //DEPT
{119, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x14, 0x9B}}, //DEPT
{121, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x14, 0xE6}}, //DEPT
{122, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x16, 0x31}}, //DEPT
{123, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x14, 0xC9}}, //DEPT
{124, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x14, 0x99}}, //DEPT
{125, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x15, 0xBC}}, //DEPT
{126, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x15, 0x7B}}, //DEPT
{127, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x16, 0xFE}}, //DEPT
{128, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x15, 0xF2}}, //DEPT
{129, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x14, 0xE8}}, //DEPT
{130, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x14, 0xA8}}, //DEPT
{131, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x15, 0x87}}, //DEPT
{132, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x15, 0xB0}}, //DEPT
{133, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x15, 0x20}}, //DEPT
{134, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x15, 0x92}}, //DEPT
{135, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x14, 0xCE}}, //DEPT
{136, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x15, 0x3E}}, //DEPT
{137, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x15, 0x4C}}, //DEPT
{138, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x16, 0x71}}, //DEPT
{139, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF2, 0xEB}}, //DEPT
{140, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF2, 0xE1}}, //DEPT
{141, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF7, 0xC3}}, //DEPT
{142, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF3, 0xAF}}, //DEPT
{143, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF7, 0xAF}}, //DEPT
{144, {0x00, 0x12, 0x4B, 0x00, 0x18, 0xD6, 0xF3, 0xF0}}, //DEPT
{145, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x16, 0x5F}}, //DEPT
{146, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x15, 0xEA}}, //DEPT
{147, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x16, 0x33}}, //DEPT
{148, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x16, 0x2D}}, //DEPT
{149, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x15, 0xC4}}, //DEPT
{150, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x15, 0x4F}}, //DEPT
{151, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x16, 0x28}}, //DEPT
{152, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x16, 0x99}}, //DEPT
{153, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x15, 0x95}}, //DEPT
{154, {0x00, 0x12, 0x4B, 0x00, 0x19, 0x40, 0x16, 0x5C}}, //DEPT

{0, {0,0,0,0,0,0,0,0}}
};

uint16_t deployment_num_nodes = sizeof(deployment_id_addr_list)/sizeof(deployment_id_addr_list[0]);

uint8_t deployment_set_node_id_ieee_addr(void)
{
  /*
   * Read the 64 bit address stored in the Contiki netstack.
   * This assumes the field to be already set.
   */
  uint8_t ieee_addr[IEEE_ADDR_LEN];
  NETSTACK_RADIO.get_object(RADIO_PARAM_64BIT_ADDR, ieee_addr, IEEE_ADDR_LEN);

  for (int i=0; i<deployment_num_nodes; i++) {
    if (memcmp(ieee_addr, deployment_id_addr_list[i].ieee_addr, IEEE_ADDR_LEN) == 0) {
      node_id = deployment_id_addr_list[i].id;
      return 1;
    }
  }

  return 0;
}

void deployment_print_id_info(void)
{
  uint8_t ieee_addr[IEEE_ADDR_LEN] = {0};
  NETSTACK_RADIO.get_object(RADIO_PARAM_64BIT_ADDR, ieee_addr, IEEE_ADDR_LEN);

  printf("[DEPLOYMENT] Node ID: %u, ", node_id);
  printf("IEEE addr: %02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x\n",
         ieee_addr[0], ieee_addr[1],
         ieee_addr[2], ieee_addr[3],
         ieee_addr[4], ieee_addr[5],
         ieee_addr[6], ieee_addr[7]);
}

bool deployment_get_addr_by_id(uint16_t node_id, linkaddr_t* addr) {
  for (uint16_t i=0; i<deployment_num_nodes; i++) {
    if (deployment_id_addr_list[i].id == node_id) {
      // copy all 8 bytes if long addresses are used or only the last two bytes
      // for short addresses.
      memcpy(addr, &deployment_id_addr_list[i].ieee_addr + IEEE_ADDR_LEN - LINKADDR_SIZE, LINKADDR_SIZE);
      return true;
    }
  }
  return false;
}

